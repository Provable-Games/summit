name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-reviews: ${{ steps.set-matrix.outputs.has-reviews }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            contracts:
              - 'contracts/**'
            frontend:
              - 'ui/**'
              - 'client/**'
            indexer-api:
              - 'indexer/**'
              - 'api/**'

      - id: set-matrix
        run: |
          ENTRIES='[]'
          if [ "${{ steps.filter.outputs.contracts }}" == "true" ]; then
            ENTRIES=$(echo "$ENTRIES" | jq -c '. + [{"prompt-file":".github/prompts/cairo-review.md","comment-header":"Cairo/Starknet Contract Review","diff-paths":"contracts/"}]')
          fi
          if [ "${{ steps.filter.outputs.frontend }}" == "true" ]; then
            ENTRIES=$(echo "$ENTRIES" | jq -c '. + [{"prompt-file":".github/prompts/client-review.md","comment-header":"React/Frontend Review","diff-paths":"ui/ client/"}]')
          fi
          if [ "${{ steps.filter.outputs.indexer-api }}" == "true" ]; then
            ENTRIES=$(echo "$ENTRIES" | jq -c '. + [{"prompt-file":".github/prompts/indexer-review.md","comment-header":"Indexer/API Review","diff-paths":"indexer/ api/"}]')
          fi
          echo "matrix={\"include\":$ENTRIES}" >> $GITHUB_OUTPUT
          if [ "$ENTRIES" = '[]' ]; then
            echo "has-reviews=false" >> $GITHUB_OUTPUT
          else
            echo "has-reviews=true" >> $GITHUB_OUTPUT
          fi

  gate:
    needs: changes
    if: needs.changes.outputs.has-reviews == 'true'
    runs-on: ubuntu-latest
    permissions:
      checks: read
    steps:
      - name: Wait for build and lint checks
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHA="${{ github.event.pull_request.head.sha }}"
          REQUIRED_CHECKS=("scarb-fmt" "scarb-test" "client-tests" "indexer-tests")
          MAX_WAIT=900  # 15 minutes
          POLL=30
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            ALL_DONE=true
            ANY_FAILED=false
            ANY_FOUND=false

            for CHECK in "${REQUIRED_CHECKS[@]}"; do
              STATUS=$(gh api "repos/${{ github.repository }}/commits/${SHA}/check-runs" \
                --jq ".check_runs[] | select(.name == \"${CHECK}\") | .status + \":\" + (.conclusion // \"\")" \
                2>/dev/null | head -1)

              if [ -z "$STATUS" ]; then
                # Check hasn't started yet — may be skipped by path filter
                continue
              fi

              ANY_FOUND=true
              RUN_STATUS="${STATUS%%:*}"
              CONCLUSION="${STATUS##*:}"

              if [ "$RUN_STATUS" != "completed" ]; then
                ALL_DONE=false
                echo "⏳ ${CHECK}: ${RUN_STATUS}"
              elif [ "$CONCLUSION" != "success" ] && [ "$CONCLUSION" != "skipped" ]; then
                echo "❌ ${CHECK}: ${CONCLUSION}"
                ANY_FAILED=true
              else
                echo "✅ ${CHECK}: ${CONCLUSION}"
              fi
            done

            if $ANY_FAILED; then
              echo "::error::One or more build/lint checks failed. Skipping review."
              exit 1
            fi

            if $ALL_DONE && $ANY_FOUND; then
              echo "All build/lint checks passed."
              exit 0
            fi

            if ! $ANY_FOUND; then
              echo "No checks found yet, waiting for workflows to start..."
            fi

            echo "Waiting ${POLL}s for checks to complete... (${ELAPSED}/${MAX_WAIT}s)"
            sleep $POLL
            ELAPSED=$((ELAPSED + POLL))
          done

          echo "::error::Timed out waiting for build/lint checks."
          exit 1

  review:
    needs: [changes, gate]
    if: needs.changes.outputs.has-reviews == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.changes.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build review prompt
        id: build-prompt
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          {
            cat "${{ matrix.prompt-file }}"

            echo ""
            echo "---"
            echo ""
            echo "This is PR #${{ github.event.pull_request.number }} for ${{ github.repository }}."
            echo ""
            echo "Review ONLY the changes introduced by the PR. Run this command to see the diff:"
            echo "  git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} -- ${{ matrix.diff-paths }}"
            echo ""
            echo "Pull request title: ${PR_TITLE}"
            echo "Pull request body:"
            echo "${PR_BODY}"
            echo ""
            echo "---"
            echo ""

            cat <<'EOF'
          Format each finding as:
          [SEVERITY] file_path:line_number — description
          Impact: what could go wrong
          Fix: concrete code change

          Where SEVERITY is one of: CRITICAL, HIGH, MEDIUM, LOW, INFO

          End with a summary: counts of findings by severity.

          IMPORTANT: Always produce output, even when no issues are found.
          If there are no actionable findings, respond with:
            "No issues found." followed by "Summary: 0 CRITICAL, 0 HIGH, 0 MEDIUM, 0 LOW, 0 INFO"
          EOF
          } > /tmp/prompt.txt

          DELIMITER=$(openssl rand -hex 16)
          echo "prompt<<${DELIMITER}" >> $GITHUB_OUTPUT
          cat /tmp/prompt.txt >> $GITHUB_OUTPUT
          echo "${DELIMITER}" >> $GITHUB_OUTPUT

      - name: Run Claude review
        id: claude-review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          direct_prompt: ${{ steps.build-prompt.outputs.prompt }}
          use_sticky_comment: true
          allowed_tools: "Bash(git diff *),Bash(git log *),Bash(git show *),Read,Glob,Grep"

      - name: Check for blocking findings
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          sleep 5  # allow comment to propagate

          # Fetch the review comment posted by the action
          BODY=$(gh api "repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            --paginate --jq '[.[] | select(.user.type == "Bot")] | last | .body // ""')

          if [ -z "$BODY" ]; then
            echo "::warning::Could not find review comment — treating as pass"
            exit 0
          fi

          # [CRITICAL] and [HIGH] with brackets only appear in actual findings,
          # not in summary lines like "0 CRITICAL, 0 HIGH"
          if echo "$BODY" | grep -qE '\[(CRITICAL|HIGH)\]'; then
            echo "::error::Review found CRITICAL or HIGH severity issues"
            exit 1
          fi

          echo "No blocking findings detected"

  summary:
    needs: [changes, review]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate results
        run: |
          if [ "${{ needs.changes.outputs.has-reviews }}" != "true" ]; then
            echo "No reviewable changes — pass"
            exit 0
          fi
          if [ "${{ needs.review.result }}" == "success" ]; then
            echo "All reviews passed"
            exit 0
          fi
          echo "::error::Review result: ${{ needs.review.result }}"
          exit 1
