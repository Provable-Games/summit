# Indexer

Real-time Starknet event indexer for Summit game state. Read [top-level AGENTS.md](../AGENTS.md) first for architecture, game mechanics, and contract addresses.

## Stack

- TypeScript 5.7.0, Node.js 22
- Apibara DNA (next) + @apibara/starknet (next) - Starknet event streaming
- Drizzle ORM 0.38.0, PostgreSQL (pg 8.13.0)
- starknet.js 7.1.0 (selector computation, hash utilities)
- Vitest 3.1.1

## Key Files

| File | Purpose |
| ---- | ------- |
| `indexers/summit.indexer.ts` | Single indexer (1889 lines): event filtering, decoding, processing, DB writes |
| `src/lib/schema.ts` | Drizzle schema: 12 tables |
| `src/lib/decoder.ts` | Bit unpacking for LiveBeastStats, event selector constants, hex utilities |
| `src/lib/decoder.test.ts` | Unit tests for decoder bit unpacking and hex utilities |
| `vitest.config.ts` | Test runner configuration |
| `apibara.config.ts` | Stream config: contract addresses, starting block 6767900, finality `pending` |
| `migrations/` | Drizzle migrations + `0001_triggers.sql` (PG NOTIFY triggers) |

## Architecture

```
DNA Stream -> Filter (5 contracts) -> Pre-scan token IDs -> Batch context lookups -> Process events -> Derived events -> Bulk inserts -> PG NOTIFY
```

### 12 Database Tables

1. `beast_stats` - Current beast state (upsert on token_id)
2. `battles` - Combat history (append-only)
3. `rewards_earned` - Reward distribution (append-only)
4. `rewards_claimed` - Rewards claimed by players (append-only)
5. `poison_events` - Poison attacks (append-only)
6. `corpse_events` - Corpse creation (append-only)
7. `skulls_claimed` - Total skulls per beast (upsert on beast_token_id)
8. `quest_rewards_claimed` - Quest rewards claimed (append-only)
9. `beast_owners` - NFT ownership (upsert on token_id)
10. `beasts` - NFT metadata (insert once)
11. `beast_data` - Dojo event data (upsert on entity_hash)
12. `summit_log` - Unified activity feed (append-only with derived events)

### Indexed Event Surface

14 event types across 5 contracts:
- Summit contract (9 selectors): BeastUpdatesEvent, LiveBeastStatsEvent, BattleEvent, RewardsEarnedEvent, RewardsClaimedEvent, PoisonEvent, QuestRewardsClaimedEvent, CorpseEvent, SkullEvent
- Beast NFT: Transfer
- Dojo World: EntityStats, CollectableEntity (via StoreSetRecord)
- Corpse contract: CorpseEvent
- Skull contract: SkullEvent

Selector constants exported from `src/lib/decoder.ts`: `EVENT_SELECTORS`, `BEAST_EVENT_SELECTORS`, `DOJO_EVENT_SELECTORS`.

## Key Patterns

- **Batch processing**: Single query per table per block (bulk inserts)
- **Idempotency**: Append tables use `onConflictDoNothing`; state tables use `onConflictDoUpdate`
- **LiveBeastStats unpacking**: Must stay in sync with `contracts/src/models/beast.cairo`
- **Derived events**: Stat upgrades and summit changes detected by comparing pre/post state
- **Battle aggregation**: Multiple attack events grouped by `tx_hash`
- **Real-time push**: DB triggers in `0001_triggers.sql` publish `summit_update` and `summit_log_insert` via PG NOTIFY, consumed by the API WebSocket layer (`api/`)

## Cross-Layer Parity

`scripts/test-live-beast-stats-parity.ts` validates decoder matches contract packing. Run with `pnpm test:parity`. CI triggers on changes to `indexer/**` or `contracts/src/models/beast.cairo`. Rule: never change decoder masks/shifts without matching contract + client changes.

## Commands

```bash
pnpm dev          # apibara dev (local indexing)
pnpm build        # apibara build
pnpm start        # apibara start (production)
pnpm test         # Vitest run
pnpm test:coverage # Vitest with coverage
pnpm test:parity  # LiveBeastStats parity validation
pnpm exec tsc --noEmit  # Typecheck only
pnpm db:generate  # drizzle-kit generate migrations
pnpm db:migrate   # drizzle-kit migrate
pnpm db:studio    # drizzle-kit studio (DB browser)
```

## CI Pipeline

`tsc --noEmit` -> build -> parity test -> test:coverage -> Codecov upload

Triggered by `indexer/**` and `contracts/src/models/beast.cairo`.

## Environment Variables

- `STREAM_URL` - Apibara DNA stream URL
- `DATABASE_URL` - PostgreSQL connection string
- `DNA_TOKEN` - Auth token for stream provider (optional)

## Deployment

Multi-stage Docker (Node 22 Alpine):
- Non-root user
- Healthcheck configured
- Startup runs DNA status check before indexer start (`check-dna && start`)
- `Dockerfile` in indexer root

## Database Schema Management

Use Drizzle Kit for all schema changes:
1. Modify `src/lib/schema.ts`
2. Run `pnpm db:generate` to create migration
3. Run `pnpm db:migrate` to apply

All tables include UUID primary key (required by Apibara Drizzle plugin for reorg handling) and three timestamps: `created_at` (Starknet), `indexed_at` (DNA), `inserted_at` (DB). PG NOTIFY triggers are in `migrations/0001_triggers.sql` (not generated by Drizzle).
