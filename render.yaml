# Summit Infrastructure Blueprint
# Deploy with: Connect repo to Render, or `render blueprint apply`
#
# Services:
#   - PostgreSQL database (managed)
#   - Indexer (background worker - processes Dojo events)
#   - API server (web service - commented out for future use)
#
# Build Filters:
#   Each service only rebuilds when its specific files change.
#   Changes to render.yaml always trigger a sync regardless of filters.

databases:
  - name: summit-db
    plan: basic-256mb # ~$7/mo - upgrade to basic-1gb ($20) or standard-1gb ($50) for production
    databaseName: summit
    postgresMajorVersion: 18
    ipAllowList: [] # Allow all IPs (Render services connect internally)
    # Uncomment for production:
    # plan: standard-1gb
    # readReplicas:
    #   - name: summit-db-replica

services:
  # ===========================================
  # Indexer (Background Worker)
  # ===========================================
  - type: worker
    name: summit-indexer
    runtime: docker
    plan: starter # $7/mo
    region: oregon
    dockerfilePath: ./indexer/Dockerfile
    dockerContext: ./indexer
    # Only rebuild when indexer files change
    buildFilter:
      paths:
        - indexer/**
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: summit-db
          property: connectionString
      - key: CONTRACT_ADDRESS
        value: "0x00345c2653c11eaecb138c49322a55a1a33a7fc13954b04e1aea701578e72609"
      - key: STREAM_URL
        value: "https://mainnet.starknet.a5a.ch"
      - key: STARTING_BLOCK
        value: "5769929" # Summit deployment block - update if contract was redeployed
      - key: DNA_TOKEN
        sync: false # Set manually (Apibara auth token)

  # ===========================================
  # API Server (REST/GraphQL) - Future Use
  # Uncomment when API is implemented
  # ===========================================
  # - type: web
  #   name: summit-api
  #   runtime: docker
  #   plan: starter # $7/mo
  #   region: oregon
  #   dockerfilePath: ./api/Dockerfile
  #   dockerContext: ./api
  #   healthCheckPath: /health
  #   buildFilter:
  #     paths:
  #       - api/**
  #       - indexer/src/lib/schema.ts
  #   envVars:
  #     - key: NODE_ENV
  #       value: production
  #     - key: PORT
  #       value: "3001"
  #     - key: DATABASE_URL
  #       fromDatabase:
  #         name: summit-db
  #         property: connectionString
  #     - key: CORS_ORIGIN
  #       sync: false # Set manually in dashboard

# ===========================================
# Environment Variable Groups
# Shared secrets across services
# ===========================================
envVarGroups:
  - name: summit-secrets
    envVars:
      - key: DNA_TOKEN
        sync: false # Must be set manually in Render dashboard
