name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: claude-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has-reviews: ${{ steps.set-matrix.outputs.has-reviews }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            contracts:
              - 'contracts/**'
            frontend:
              - 'ui/**'
              - 'client/**'
            indexer-api:
              - 'indexer/**'
              - 'api/**'

      - id: set-matrix
        run: |
          ENTRIES='[]'
          if [ "${{ steps.filter.outputs.contracts }}" == "true" ]; then
            ENTRIES=$(echo "$ENTRIES" | jq -c '. + [{"prompt-file":".github/prompts/cairo-review.md","comment-header":"Cairo/Starknet Contract Review","diff-paths":"contracts/"}]')
          fi
          if [ "${{ steps.filter.outputs.frontend }}" == "true" ]; then
            ENTRIES=$(echo "$ENTRIES" | jq -c '. + [{"prompt-file":".github/prompts/client-review.md","comment-header":"React/Frontend Review","diff-paths":"ui/ client/"}]')
          fi
          if [ "${{ steps.filter.outputs.indexer-api }}" == "true" ]; then
            ENTRIES=$(echo "$ENTRIES" | jq -c '. + [{"prompt-file":".github/prompts/indexer-review.md","comment-header":"Indexer/API Review","diff-paths":"indexer/ api/"}]')
          fi
          echo "matrix={\"include\":$ENTRIES}" >> $GITHUB_OUTPUT
          if [ "$ENTRIES" = '[]' ]; then
            echo "has-reviews=false" >> $GITHUB_OUTPUT
          else
            echo "has-reviews=true" >> $GITHUB_OUTPUT
          fi

  review:
    needs: changes
    if: needs.changes.outputs.has-reviews == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.changes.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build review prompt
        id: build-prompt
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          {
            cat "${{ matrix.prompt-file }}"

            echo ""
            echo "---"
            echo ""
            echo "This is PR #${{ github.event.pull_request.number }} for ${{ github.repository }}."
            echo ""
            echo "Review ONLY the changes introduced by the PR. Run this command to see the diff:"
            echo "  git diff ${{ github.event.pull_request.base.sha }}...${{ github.event.pull_request.head.sha }} -- ${{ matrix.diff-paths }}"
            echo ""
            echo "Pull request title: ${PR_TITLE}"
            echo "Pull request body:"
            echo "${PR_BODY}"
            echo ""
            echo "---"
            echo ""

            cat <<'EOF'
          Format each finding as:
          [SEVERITY] file_path:line_number â€” description
          Impact: what could go wrong
          Fix: concrete code change

          Where SEVERITY is one of: CRITICAL, HIGH, MEDIUM, LOW, INFO

          End with a summary: counts of findings by severity.
          EOF
          } > /tmp/prompt.txt

          DELIMITER=$(openssl rand -hex 16)
          echo "prompt<<${DELIMITER}" >> $GITHUB_OUTPUT
          cat /tmp/prompt.txt >> $GITHUB_OUTPUT
          echo "${DELIMITER}" >> $GITHUB_OUTPUT

      - name: Run Claude review
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          direct_prompt: ${{ steps.build-prompt.outputs.prompt }}
          use_sticky_comment: true
          allowed_tools: "Bash(git diff *),Bash(git log *),Bash(git show *),Read,Glob,Grep"
